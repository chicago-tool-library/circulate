<%= content_for :header do %>
  <%= index_header "Items in maintenance" %>
<% end %>

<section class="filters-container">
  <h2>Filters</h2>
  <%= form_with(url: admin_reports_items_in_maintenance_index_path, class: "filters-form", method: :get) do |f| %>
    <div class="filters-form-fields">
      <div class="filter-column item-and-ticket-filters">
        <div class="filter-row item-filters">
          <div class="filter-field name">
            <%= f.label :"q[item_name_cont]", "Item Name" %>
            <%= f.search_field :"q[item_name_cont]", value: params.dig(:q, :item_name_cont) %>
          </div>

          <div class="filter-field status">
            <%= f.label :"q[item_status_eq]", "Item Status" %>
            <%= f.select :"q[item_status_eq]", Item.statuses.values.sort.map { |value| [value.humanize, value] }, {include_blank: true, selected: params.dig(:q, :item_status_eq)} %>
          </div>

          <div class="filter-field number">
            <%= f.label :"q[item_number_eq]", "Item Number" %>
            <%= f.search_field :"q[item_number_eq]", value: params.dig(:q, :item_number_eq) %>
          </div>
        </div>
        <div class="filter-row ticket-filters">
          <div class="filter-field title">
            <%= f.label :"q[title_cont]", "Ticket Title" %>
            <%= f.search_field :"q[title_cont]", value: params.dig(:q, :title_cont) %>
          </div>

          <div class="filter-field status">
            <%= f.label :"q[status_eq]", "Ticket Status" %>
            <%= f.select :"q[status_eq]", [["Assess", "assess"], ["Parts", "parts"], ["Repairing", "repairing"]], {include_blank: true, selected: params.dig(:q, :status_eq)} %>
          </div>

          <div class="filter-field tag">
            <%= f.label :tags_name_in, "Tag" %>
            <%= f.select :tags_name_in, ActsAsTaggableOn::Tag.most_used.pluck(:name), {include_blank: true, selected: params[:tags_name_in]} %>
          </div>
        </div>
      </div>

      <div class="filter-column date-filters">
        <div class="filter-row">
          <div class="filter-field">
            <%= f.label :"q[created_at_gteq]", "Created After" %>
            <%= f.date_field :"q[created_at_gteq]", value: params.dig(:q, :created_at_gteq) %>
          </div>

          <div class="filter-field">
            <%= f.label :"q[created_at_lteq]", "Created Before" %>
            <%= f.date_field :"q[created_at_lteq]", value: params.dig(:q, :created_at_lteq) %>
          </div>
        </div>

        <div class="filter-row">
          <div class="filter-field">
            <%= f.label :"q[updated_at_gteq]", "Updated After" %>
            <%= f.date_field :"q[updated_at_gteq]", value: params.dig(:q, :updated_at_gteq) %>
          </div>

          <div class="filter-field">
            <%= f.label :"q[updated_at_lteq]", "Updated Before" %>
            <%= f.date_field :"q[updated_at_lteq]", value: params.dig(:q, :updated_at_lteq) %>
          </div>
        </div>
      </div>
    </div>

    <div class="filter-button-container">
      <%= f.submit "Filter", class: "btn" %>
    </div>
  <% end %>
</section>

<% if @tickets.any? %>
  <div class="column col-12">
    <table class="table">
      <tr>
        <th><%= sort_link(@q, :item_number, "Number") %></th>
        <th><%= sort_link(@q, :item_status, "Status") %></th>
        <th><%= sort_link(@q, :item_name, "Name") %></th>
        <th>Categories</th>
        <th><%= sort_link(@q, :title, "Title") %></th>
        <th><%= sort_link(@q, :status, "Status") %></th>
        <th>Tags</th>
        <th><%= sort_link(@q, :created_at, "Created") %></th>
        <th><%= sort_link(@q, :updated_at, "Updated") %></th>
      </tr>
      <% @tickets.each do |ticket| %>
        <tr>
          <td>
            <%= ticket.item.complete_number %>
          </td>
          <td>
            <%= ticket.item.status %>
          </td>
          <td>
            <%= link_to ticket.item.name, admin_item_tickets_path(ticket.item) %>
          </td>
          <td>
            <%= ticket.item.categories.map(&:name).join(", ") %>
          </td>
          <td>
            <%= link_to ticket.title, admin_item_ticket_path(ticket.item, ticket) %>
          </td>
          <td>
            <%= ticket.status %>
          </td>
          <td>
            <%= ticket.tag_list %>
          </td>
          <td>
            <%= ticket.created_at.to_formatted_s(:short_date) %>
          </td>
          <td>
            <%= ticket.updated_at.to_formatted_s(:short_date) %>
          </td>
        </tr>
      <% end %>
    </table>
  </div>
<% else %>
  <%= empty_state "There are no items that match the current filters!" %>
<% end %>
